<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>商品一覧</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
</head>
<body>
    
<div class="search-bar">
    <h1>KIMUZON</h1>
    <!-- 商品検索とカテゴリー選択 -->
    <form th:action="@{/products}" method="get" class="search-form">
        <input type="text" name="keyword" placeholder="商品名を検索" th:value="${keyword}" />
        
        <select name="category">
            <option value="">すべてのカテゴリー</option>
            <option value="本" th:selected="${category == '本'}">本</option>
            <option value="家電" th:selected="${category == '家電'}">家電</option>
            <option value="ファッション" th:selected="${category == 'ファッション'}">ファッション</option>
            <option value="ゲーム" th:selected="${category == 'ゲーム'}">ゲーム</option>
            <option value="日用品" th:selected="${category == '日用品'}">日用品</option>
            <option value="ドラッグ" th:selected="${category == 'ドラッグ'}">ドラッグ</option>
        </select>
        
        <button type="submit">検索</button>
    </form>
    <!-- 商品登録・カート・注文履歴へのリンク -->
    <div class="top-links" th:if="${loginUser != null}" >
        <div sec:authorize="hasAnyRole('ROLE_ADMIN')" class="admin-links">
            <a href="/products/new">商品を登録する</a>
        </div>
        <a href="/orders">注文履歴</a>
        <a href="/cart/view">カート</a>
        <span th:text="${loginUser.userName + '( '+ loginUser.role + ')'}" class="userName">ユーザー名</span>
        <!-- <form th:action="@{/logout}" method="post"
                onsubmit="return confirm('本当にログアウトしますか？')">
            <button type="submit" class="logout-button">ログアウト</button>
        </form> -->
        <button class="logout-button" onclick="openModal()">ログアウト</button>
    </div>
    <!-- ログアウト確認モーダル -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
                <p>本当にログアウトしますか？</p>
            <div class="modal-buttons">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="confirm-btn">はい</button>
                </form>
                <button class="cancel-btn" onclick="closeModal()">キャンセル</button>
            </div>
        </div>
    </div>
</div>
    <div class="product-grid">
        <div class="product-card" th:each="product : ${products}">
            <!-- 商品画像のサムネイル -->
            <a th:href="@{'/products/' + ${product.id}}">
                <img th:if="${product.imagePaths != null and !product.imagePaths.isEmpty()}" 
                th:src="@{'/uploads/' + ${product.imagePaths[0]}}" alt="商品画像">
                <span th:if="${product.imagePaths == null or product.imagePaths.isEmpty()}">画像なし</span><br>
            </a>
            <!-- 商品名（クリックで詳細ページへ遷移） -->
            <a th:href="@{'/products/' + ${product.id}}" th:text="${product.name}">商品名</a>
            <!-- <p th:text="${product.description}">商品説明</p> -->
            <p class="price" th:text="${'¥' + product.price}">価格</p>
                <div sec:authorize="hasAnyRole('ROLE_ADMIN')">
                    <a th:href="@{/products/edit/{id}(id=${product.id})}">編集</a>
                    <a th:href="@{/products/delete(id=${product.id})}" onclick="return confirm('削除してもよいですか？');">削除</a>
                </div>
            
            <!-- カートに追加ボタン -->
            <div th:if="${cart[product.id] == null}">
                <form th:action="@{/cart/add/{id}(id=${product.id})}" method="post">
                    <button type="submit">カートに追加</button>
                </form>
            </div>
            <!-- カートに入っている：数量と＋－ボタン -->
            <div th:if="${cart[product.id] != null}">
                <form th:action="@{/cart/decrease/{id}(id=${product.id})}" method="post" style="display:inline;">
                    <button type="submit">-</button>
                </form>
                <span th:text="${cart[product.id].quantity}"></span>
                <form th:action="@{/cart/increase/{id}(id=${product.id})}" method="post" style="display:inline;">
                    <button type="submit">+</button>
                </form>
            </div>
        </div>
    </div>
    <script th:src="@{/js/scroll-toggle.js}"></script>
    <script th:src="@{/js/cart-button.js}"></script>
    <script th:src="@{/js/logout-button.js}"></script>
</body>
</html>